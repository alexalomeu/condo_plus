<div class="container">
  <div class="d-flex align-items-center mb-3">
    <%= link_to "javascript:history.back()", class: "text-decoration-none text-blue me-3 d-flex align-items-center" do %>
      <i class="bi bi-arrow-left"></i>
    <% end %>
    <div>
      <h2 class="fw-bold mb-0">Atribuições</h2>
      <span class="text-blue-muted">Gerencie os vínculos entre síndicos, condomínios e imobiliárias</span>
    </div>
  </div>

  <div class="row g-4">
    <!-- Síndico → Condomínio -->
    <div class="col-md-6">
      <div class="card shadow-sm border-0">
        <div class="card-body">
          <h5 class="card-title">Atribuir Síndico ao Condomínio</h5>
          <p class="text-blue-muted small">Um condomínio pode ter apenas 1 síndico</p>

          <div class="mb-3">
            <label class="form-label">Síndico</label>
            <select id="managerSelect" class="form-select">
              <option value="">Selecione um síndico</option>
              <% @managers.each do |m| %>
                <option value="<%= m[:id] %>"><%= m[:name] %></option>
              <% end %>
            </select>
          </div>

          <div class="text-center my-3">
            <i class="bi bi-arrow-right text-blue-muted fs-4"></i>
          </div>

          <div class="mb-3">
            <label class="form-label">Condomínio</label>
            <select id="managerCondoSelect" class="form-select">
              <option value="">Selecione um condomínio</option>
              <% @condos.each do |c| %>
                <option value="<%= c[:id] %>"><%= c[:name] %></option>
              <% end %>
            </select>
          </div>

          <button class="btn btn-primary w-100" onclick="assignManager()">Confirmar Atribuição</button>
        </div>
      </div>
    </div>

    <!-- Condomínio → Imobiliária -->
    <div class="col-md-6">
      <div class="card shadow-sm border-0">
        <div class="card-body">
          <h5 class="card-title">Atribuir Condomínio à Imobiliária</h5>
          <p class="text-blue-muted small">Um condomínio pode ter apenas 1 imobiliária</p>

          <div class="mb-3">
            <label class="form-label">Condomínio</label>
            <select id="realEstateCondoSelect" class="form-select">
              <option value="">Selecione um condomínio</option>
              <% @condos.each do |c| %>
                <option value="<%= c[:id] %>"><%= c[:name] %></option>
              <% end %>
            </select>
          </div>

          <div class="text-center my-3">
            <i class="bi bi-arrow-right text-blue-muted fs-4"></i>
          </div>

          <div class="mb-3">
            <label class="form-label">Imobiliária</label>
            <select id="realEstateSelect" class="form-select">
              <option value="">Selecione uma imobiliária</option>
              <% @real_estates.each do |r| %>
                <option value="<%= r[:id] %>"><%= r[:name] %></option>
              <% end %>
            </select>
          </div>

          <button class="btn btn-primary w-100" onclick="assignRealEstate()">Confirmar Atribuição</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabelas -->
  <div class="row g-4 mt-5">
    <!-- Vínculos Síndico → Condomínio -->
    <div class="col-md-6">
      <div class="card shadow-sm border-0">
        <div class="card-body">
          <h5 class="card-title">Vínculos Síndico → Condomínio</h5>
          <table class="table table-hover align-middle">
            <thead class="table-light">
              <tr>
                <th class="text-blue-muted">Síndico</th>
                <th class="text-blue-muted">Condomínio</th>
                <th class="text-end text-blue-muted">Ações</th>
              </tr>
            </thead>
            <tbody id="managerAssignmentsTable">
              <tr><td colspan="3" class="text-center text-blue-muted">Nenhum vínculo</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Vínculos Condomínio → Imobiliária -->
    <div class="col-md-6">
      <div class="card shadow-sm border-0">
        <div class="card-body">
          <h5 class="card-title">Vínculos Condomínio → Imobiliária</h5>
          <table class="table table-hover align-middle">
            <thead class="table-light">
              <tr>
                <th class="text-blue-muted">Condomínio</th>
                <th class="text-blue-muted">Imobiliária</th>
                <th class="text-end text-blue-muted">Ações</th>
              </tr>
            </thead>
            <tbody id="realEstateAssignmentsTable">
              <tr><td colspan="3" class="text-center text-blue-muted">Nenhum vínculo</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- JS Inline (simula lógica do React) -->
<script>
  const managerAssignments = [];
  const realEstateAssignments = [];

  function assignManager() {
    const managerSelect = document.getElementById("managerSelect");
    const condoSelect = document.getElementById("managerCondoSelect");
    const managerId = managerSelect.value;
    const condoId = condoSelect.value;

    if (!managerId || !condoId) {
      alert("Selecione um síndico e um condomínio.");
      return;
    }

    // Regra: um condomínio só pode ter 1 síndico
    if (managerAssignments.some(a => a.condoId === condoId)) {
      alert("Este condomínio já possui um síndico atribuído.");
      return;
    }

    managerAssignments.push({ managerId, condoId });

    const table = document.getElementById("managerAssignmentsTable");
    if (table.querySelector(".text-center")) table.innerHTML = "";

    table.innerHTML += `
      <tr data-condo-id="${condoId}" data-manager-id="${managerId}">
        <td>${managerSelect.options[managerSelect.selectedIndex].text}</td>
        <td>${condoSelect.options[condoSelect.selectedIndex].text}</td>
        <td class='text-end'>
          <button class='btn btn-sm btn-outline-danger' onclick='removeManagerAssignment("${managerId}", "${condoId}")'>
            <i class='bi bi-trash'></i>
          </button>
        </td>
      </tr>`;

    updateManagerOptions();
  }

  function assignRealEstate() {
    const condoSelect = document.getElementById("realEstateCondoSelect");
    const realEstateSelect = document.getElementById("realEstateSelect");
    const condoId = condoSelect.value;
    const realEstateId = realEstateSelect.value;

    if (!condoId || !realEstateId) {
      alert("Selecione uma imobiliária e um condomínio.");
      return;
    }

    // Regra: um condomínio só pode ter 1 imobiliária
    if (realEstateAssignments.some(a => a.condoId === condoId)) {
      alert("Este condomínio já possui uma imobiliária atribuída.");
      return;
    }
  }

    realEstateAssignments.push({ condoId, realEstateId });

    const table = document.getElementById("realEstateAssignmentsTable");
    if (table.querySelector(".text-center")) table.innerHTML = "";

    table.innerHTML += `
      <tr data-condo-id="${condoId}" data-real-estate-id="${realEstateId}">
        <td>${condoSelect.options[condoSelect.selectedIndex].text}</td>
        <td>${realEstateSelect.options[realEstateSelect.selectedIndex].text}</td>
        <td class='text-end'>
          <button class='btn btn-sm btn-outline-danger' onclick='removeRealEstateAssignment("${condoId}", "${realEstateId}")'>
            <i class='bi bi-trash'></i>
          </button>
        </td>
      </tr>`;

    updateRealEstateOptions();
  }

  function removeManagerAssignment(managerId, condoId) {
    const index = managerAssignments.findIndex(a => a.managerId === managerId && a.condoId === condoId);
    if (index !== -1) managerAssignments.splice(index, 1);

    document.querySelector(`tr[data-condo-id="${condoId}"][data-manager-id="${managerId}"]`)?.remove();
    if (managerAssignments.length === 0) {
      document.getElementById("managerAssignmentsTable").innerHTML =
        `<tr><td colspan="3" class="text-center text-blue-muted">Nenhum vínculo</td></tr>`;
    }

    updateManagerOptions();
  }

  function removeRealEstateAssignment(condoId, realEstateId) {
    const index = realEstateAssignments.findIndex(a => a.condoId === condoId && a.realEstateId === realEstateId);
    if (index !== -1) realEstateAssignments.splice(index, 1);

    document.querySelector(`tr[data-condo-id="${condoId}"][data-real-estate-id="${realEstateId}"]`)?.remove();
    if (realEstateAssignments.length === 0) {
      document.getElementById("realEstateAssignmentsTable").innerHTML =
        `<tr><td colspan="3" class="text-center text-blue-muted">Nenhum vínculo</td></tr>`;
    }

    updateRealEstateOptions();
  }

  // Atualiza opções dos selects, desabilitando condomínios já usados
  function updateManagerOptions() {
    const condoSelect = document.getElementById("managerCondoSelect");
    Array.from(condoSelect.options).forEach(opt => {
      if (!opt.value) return;
      opt.disabled = managerAssignments.some(a => a.condoId === opt.value);
    });
  }

  function updateRealEstateOptions() {
    const condoSelect = document.getElementById("realEstateCondoSelect");
    Array.from(condoSelect.options).forEach(opt => {
      if (!opt.value) return;
      opt.disabled = realEstateAssignments.some(a => a.condoId === opt.value);
    });
  }
</script>
